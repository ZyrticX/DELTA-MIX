# 📊 מערכת ניתוח קורלציה S&P 500

מערכת מתקדמת לניתוח קורלציות בין מניות ל-S&P 500, זיהוי הזדמנויות מסחר, ועדכון אוטומטי יומי.

## 🎯 מה המערכת עושה?

המערכת משכפלת **בדיוק** את הלוגיקה של גיליונות האקסל שלך, אבל:
- ✅ עובדת על **כל 500 מניות של S&P 500**
- ✅ מתחילה מ-**1.1.2012** (או כל תאריך אחר)
- ✅ **מתעדכנת אוטומטית** כל לילה
- ✅ כוללת **ממשק גרפי** נוח לשינוי פרמטרים
- ✅ **בלחיצת כפתור** - מקבל את כל ההתאמות

## 🔧 התקנה

### שלב 1: התקנת Python
ודא שיש לך Python 3.8 ומעלה מותקן:
```bash
python --version
```

### שלב 2: התקנת החבילות
```bash
pip install yfinance pandas numpy openpyxl streamlit plotly scipy
```

או:
```bash
pip install -r requirements.txt
```

### שלב 3: הורדת הקבצים
העתק את כל הקבצים לתיקייה אחת:
- `deltamix.py` - הממשק הגרפי
- `correlation_engine.py` - מנוע החישוב
- `data_fetcher.py` - הורדת נתונים
- `daily_update.py` - עדכון אוטומטי
- `config.json` - קובץ הגדרות (ייווצר אוטומטית)

## 🚀 הפעלה

### הפעלת הממשק הגרפי
```bash
streamlit run deltamix.py
```

הממשק ייפתח בדפדפן בכתובת: `http://localhost:8501`

### הרצה מהטרמינל (ללא ממשק)
```bash
python daily_update.py
```

## 📖 מדריך שימוש

### 1️⃣ הגדרת פרמטרים
בסרגל הצד (Sidebar), הגדר:

**פרמטרי חישוב:**
- **אורך בלוק קורלציה**: 15 ימים (ברירת מחדל)
- **סף מובהקות**: 0.7 (ערכים: 0-1)
- **סוג חישוב**:
  - 1 = קורלציית שער בלבד
  - 2 = קורלציית מחזור בלבד
  - 3 = מכפלת קורלציות (מומלץ)
- **אורך ממוצע נע**: 10 ימים
- **סף מהותיות**: 1%

**הגדרות נתונים:**
- **תאריך התחלה**: 2012-01-01 (ברירת מחדל)
- **תאריך סיום**: היום
- **מניית ייחוס**: SPY (S&P 500 ETF)
- **מספר מניות**: 50-500

### 2️⃣ טעינת נתונים
1. לחץ על כפתור **"🔄 טען נתונים"**
2. המערכת תוריד את הנתונים מ-Yahoo Finance
3. הנתונים נשמרים בקאש לשימוש מהיר בעתיד

**הערה:** ההורדה הראשונה עשויה לקחת מספר דקות (תלוי במספר המניות)

### 3️⃣ הרצת ניתוח
1. לאחר טעינת הנתונים, לחץ **"▶️ הרץ ניתוח"**
2. המערכת תריץ את כל החישובים
3. התוצאות יוצגו אוטומטית

### 4️⃣ צפייה בתוצאות

**סטטיסטיקה כללית:**
- סה"כ הזדמנויות UP
- סה"כ ימים DOWN
- סה"כ ימים כשירים
- מספר מניות

**טבלת מניות:**
- מיון לפי מספר הזדמנויות
- חיפוש מניה ספציפית
- סינון לפי מינימום הזדמנויות
- הורדת הטבלה ל-CSV

**הזדמנויות להיום:**
- רשימת המניות עם הזדמנויות **עכשיו**
- מדורגות לפי קורלציה

**גרפים:**
- התפלגות הזדמנויות
- קורלציות לאורך זמן
- היסטוגרמה

### 5️⃣ ייצוא תוצאות
- **Excel**: כל הגיליונות כמו באקסל המקורי
- **CSV**: טבלת סטטיסטיקה
- **PDF**: דו"ח מסכם (בקרוב)

## 🤖 עדכון אוטומטי יומי

### הגדרת עדכון אוטומטי (Windows)

#### אופן 1: Task Scheduler
1. פתח **Task Scheduler**
2. צור **New Task**
3. **Trigger**: Daily, 23:00 (או כל שעה אחרי סגירת השוק)
4. **Action**: 
   - Program: `python`
   - Arguments: `C:\path\to\daily_update.py`
5. שמור

#### אופן 2: קובץ BAT
צור קובץ `run_update.bat`:
```batch
@echo off
cd C:\path\to\project
python daily_update.py
pause
```

הפעל אותו דרך Task Scheduler.

### הגדרת עדכון אוטומטי (Linux/Mac)

#### שימוש ב-Cron
פתח את crontab:
```bash
crontab -e
```

הוסף שורה:
```bash
0 23 * * * cd /path/to/project && python3 daily_update.py
```

זה יריץ את העדכון כל יום ב-23:00.

## 📁 מבנה הקבצים

```
project/
│
├── deltamix.py                 # ממשק גרפי (Streamlit)
├── correlation_engine.py       # מנוע החישוב (משכפל את האקסל)
├── data_fetcher.py            # הורדת נתונים מ-Yahoo Finance
├── daily_update.py            # סקריפט עדכון אוטומטי
├── config.json                # קובץ הגדרות
├── requirements.txt           # רשימת חבילות
├── README.md                  # מדריך זה
│
├── data_cache/                # קאש של נתונים שהורדו
│   ├── AAPL_2012-01-01_2024-11-04.pkl
│   └── ...
│
└── daily_results/             # תוצאות יומיות
    ├── opportunities_20241104.json
    ├── statistics_20241104.csv
    └── ...
```

## ⚙️ קובץ הגדרות (config.json)

```json
{
  "block_length": 15,
  "significance": 0.7,
  "calc_mode": 3,
  "ma_length": 10,
  "threshold": 0.01,
  "start_date": "2012-01-01",
  "reference_symbol": "SPY",
  "num_stocks": 500,
  "notification_email": null,
  "min_opportunities_alert": 5
}
```

ניתן לערוך ידנית או דרך הממשק.

## 🔬 איך זה עובד? (טכני)

### שלב 1: חישוב קורלציות גליליות (Rolling Correlations)
```python
# עבור כל מניה וכל יום:
CORREL(
    [15 מחירים אחרונים של המניה],
    [15 מחירים אחרונים של SPY]
)
```

זהה לנוסחה באקסל:
```excel
=CORREL(OFFSET(D2,0,0,15,1), OFFSET(REF_PRICE,0,0,15,1))
```

### שלב 2: שילוב קורלציות
במצב 3 (מכפלה):
```python
if price_corr < 0 or volume_corr < 0:
    combined = 0
else:
    combined = price_corr × volume_corr
```

### שלב 3: יחס לממוצע נע
```python
avg_volume = AVERAGE([10 נפחים אחרונים])
ratio = avg_volume / current_volume

if ratio > 1.01 and combined > 0.7:
    # זו הזדמנות!
```

### שלב 4: סיכום סטטיסטי
```python
UP = count(ratio > 1.01)
DOWN = count(ratio > 0 and ratio <= 1.01)
TOTAL = count(ratio > 0)
```

## 🎨 התאמה אישית

### שינוי מניית ייחוס
במקום SPY, אפשר להשתמש ב:
- **QQQ**: Nasdaq 100
- **DIA**: Dow Jones
- **IWM**: Russell 2000
- **VTI**: Total Stock Market

### הוספת אינדיקטורים נוספים
ניתן להוסיף למנוע החישוב (`correlation_engine.py`):
- RSI
- MACD
- Bollinger Bands
- וכו'

### שינוי אלגוריתם הקורלציה
כרגע: Pearson Correlation
אפשר: Spearman, Kendall, וכו'

## ❓ שאלות נפוצות (FAQ)

### ש: כמה זמן לוקחת ההורדה הראשונה?
**ת:** תלוי במספר המניות:
- 50 מניות: ~2-3 דקות
- 100 מניות: ~5-7 דקות
- 500 מניות: ~20-30 דקות

### ש: האם הנתונים מדויקים?
**ת:** כן! הנתונים מ-Yahoo Finance זהים לאלה בטרמינלים מקצועיים. המערכת משכפלת **בדיוק** את הנוסחאות מהאקסל.

### ש: מה קורה אם מניה הוסרה מה-S&P 500?
**ת:** המערכת תדלג עליה ותמשיך עם השאר. הקאש ישמור את הנתונים ההיסטוריים.

### ש: אפשר להריץ על מדדים אחרים?
**ת:** כן! רק צריך לספק רשימת סימולים במקום `get_sp500_symbols()`.

### ש: יש תמיכה במובייל?
**ת:** הממשק של Streamlit עובד גם בדפדפן נייד, אבל מומלץ מחשב.

### ש: כמה זיכרון צריך?
**ת:** 
- 50 מניות: ~100 MB
- 500 מניות: ~500 MB
- עם קאש: כפול 2

### ש: אפשר לשנות את שעת העדכון?
**ת:** כן, פשוט שנה את ה-Cron או Task Scheduler.

## 🐛 פתרון בעיות

### בעיה: "No module named 'yfinance'"
**פתרון:**
```bash
pip install yfinance
```

### בעיה: "HTTPError: 404"
**פתרון:** המניה לא נמצאה. בדוק את הסימול.

### בעיה: הממשק לא נפתח
**פתרון:**
```bash
streamlit run deltamix.py --server.port 8502
```

### בעיה: חישובים לוקחים זמן רב
**פתרון:** התחל עם פחות מניות (50-100), ואז הגדל.

### בעיה: שגיאת זיכרון
**פתרון:** הקטן את `num_stocks` או הגדל את תאריך ההתחלה.

## 📝 טיפים לשימוש אופטימלי

1. **בדיקה ראשונית**: התחל עם 50 מניות ושנה אחת לבדיקה
2. **קאש**: השתמש בקאש! זה מאיץ פי 100
3. **פרמטרים**: נסה ערכים שונים ל-`significance` (0.5-0.9)
4. **תקופה**: מינימום שנתיים נתונים לקורלציה טובה
5. **עדכון**: הרץ עדכון יומי **אחרי** סגירת השוק (16:00 ET)

## 🔐 אבטחה ופרטיות

- ✅ הנתונים נשמרים **רק במחשב שלך**
- ✅ אין העברת מידע לשרתים חיצוניים
- ✅ Yahoo Finance API הוא ציבורי וחינמי
- ⚠️ אל תשתף את `config.json` אם יש בו פרטי email

## 📞 תמיכה

בעיות? יש רעיונות?
- צור issue
- שלח PR
- כתב בפורום

## 📄 רישיון

MIT License - חופשי לשימוש מסחרי ואישי

## 🙏 תודות

- **yfinance**: ספריית הורדת נתונים מעולה
- **Streamlit**: ממשק נפלא וקל
- **Plotly**: גרפים אינטראקטיביים

## 🚀 גרסאות עתידיות

- [ ] תמיכה במסחר אוטומטי (API לברוקרים)
- [ ] למידת מכונה לחיזוי קורלציות
- [ ] אפליקציית מובייל
- [ ] התראות SMS/WhatsApp
- [ ] ניתוח sentiment מחדשות
- [ ] backtesting מתקדם

---

**בהצלחה עם המערכת! 📊💰**

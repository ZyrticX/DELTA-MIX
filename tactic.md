# 🔬 איך מחושבת הקורלציה באקסל שלך - הסבר מפורט

## 📊 סקירה כללית

הקורלציה באקסל שלך מחושבת ב-**3 שלבים**:

1. **קורלציית מחיר** (גיליון "שער")
2. **קורלציית נפח** (גיליון "מחזור")  
3. **שילוב** (גיליון "חישוב")

---

## 🎯 שלב 1: קורלציית מחיר (גיליון "שער")

### הנוסחה המלאה:

```excel
=IF($A2>1230,0,
   IF($X$2=1,
      CORREL(OFFSET(D2,0,0,פרמטרים!$E$2,1),
             OFFSET(פרמטרים!$C$2,0,0,פרמטרים!$E$2,1)),
      IF($X$2=2,
         CORREL(OFFSET(D2,0,0,פרמטרים!$E$2,1),
                OFFSET(פרמטרים!$D$2,0,0,פרמטרים!$E$2,1)),
         0)))
```

### פירוק צעד אחר צעד:

#### תנאי 1: בדיקת שורה
```excel
IF($A2>1230, 0, ...)
```
- בודק אם מספר השורה גדול מ-1230
- אם כן → אין מספיק נתונים היסטוריים, מחזיר 0
- אם לא → ממשיך לחישוב

#### תנאי 2: בדיקת מצב חישוב
```excel
IF($X$2=1, ..., IF($X$2=2, ..., 0))
```
- תא `$X$2` = מצב החישוב (1 או 2)
- **מצב 1**: קורלציה למחיר ייחוס (`פרמטרים!$C$2`)
- **מצב 2**: קורלציה לנפח ייחוס (`פרמטרים!$D$2`)

#### חישוב הקורלציה:
```excel
CORREL(טווח_מניה, טווח_ייחוס)
```

**טווח המניה:**
```excel
OFFSET(D2, 0, 0, פרמטרים!$E$2, 1)
```
- `D2` = מחיר MSFT בשורה נוכחית
- `0, 0` = לא זז מהתא
- `פרמטרים!$E$2` = 15 (אורך בלוק)
- `1` = עמודה אחת ברוחב

**תוצאה:** 15 המחירים האחרונים של MSFT

**טווח הייחוס:**
```excel
OFFSET(פרמטרים!$C$2, 0, 0, פרמטרים!$E$2, 1)
```
- מתחיל ממחיר הייחוס בגיליון פרמטרים
- לוקח 15 ערכים

**תוצאה:** 15 מחירי הייחוס האחרונים

### 📐 נוסחת קורלציה פירסון (CORREL)

```
          Σ[(xi - x̄)(yi - ȳ)]
r = ────────────────────────────────
    √[Σ(xi - x̄)²] × √[Σ(yi - ȳ)²]
```

כאשר:
- `xi` = מחירי המניה
- `yi` = מחירי הייחוס
- `x̄` = ממוצע מחירי המניה
- `ȳ` = ממוצע מחירי הייחוס
- `r` = מקדם הקורלציה (-1 עד 1)

---

## 🎯 שלב 2: קורלציית נפח (גיליון "מחזור")

### הנוסחה זהה, אבל:

במקום **מחירים** → משווה **נפחי מסחר**

```excel
=IF($A2>1230,0,
   IF($X$2=1,
      CORREL(OFFSET(D2,0,0,פרמטרים!$E$2,1),     ← נפחי המניה
             OFFSET(פרמטרים!$C$2,0,0,פרמטרים!$E$2,1)),  ← נפחי ייחוס
      ...))
```

**אותה לוגיקה:**
- לוקח 15 נפחי מסחר אחרונים של המניה
- משווה ל-15 נפחי מסחר אחרונים של הייחוס
- מחשב קורלציה ביניהם

---

## 🎯 שלב 3: שילוב (גיליון "חישוב")

### הנוסחה:

```excel
=IF(פרמטרים!$G$2=1, שער!M2,
   IF(פרמטרים!$G$2=2, מחזור!M2,
      IF(פרמטרים!$G$2=3,
         (IF(OR(שער!M2<0, מחזור!M2<0), 0, שער!M2*מחזור!M2)),
         0)))
```

### 3 מצבים אפשריים:

#### מצב 1: קורלציית שער בלבד
```excel
IF(פרמטרים!$G$2=1, שער!M2, ...)
```
- לוקח רק את קורלציית המחיר
- מתעלם מנפח המסחר

#### מצב 2: קורלציית מחזור בלבד
```excel
IF(פרמטרים!$G$2=2, מחזור!M2, ...)
```
- לוקח רק את קורלציית הנפח
- מתעלם ממחירים

#### מצב 3: מכפלה (שילוב חכם) ⭐
```excel
IF(OR(שער!M2<0, מחזור!M2<0), 0, שער!M2*מחזור!M2)
```

**הלוגיקה:**

1. **בודק שתיהן חיוביות:**
   ```
   IF(OR(שער<0, מחזור<0), ...)
   ```
   - אם אחת מהן שלילית → תוצאה = 0
   - **למה?** רוצים שגם המחיר וגם הנפח יזוזו באותו כיוון עם הייחוס

2. **מכפלה:**
   ```
   שער × מחזור
   ```
   - דוגמה: 0.85 × 0.72 = 0.612
   - זה מחזק את האות רק אם שתיהן חזקות

---

## 💡 דוגמה מעשית מהאקסל שלך

### נתונים מיום 2024-04-05 (שורה 1):

```
מניה: MSFT
────────────────────────

📊 נתוני גלם:
├─ מחיר: $425.52
└─ נפח: 16,544,300

🔬 חישוב קורלציות:

שלב 1 - קורלציית שער:
├─ 15 מחירי MSFT אחרונים: [425.52, 417.88, 420.45, ...]
├─ 15 מחירי ייחוס אחרונים: [205.04, ...]
└─ קורלציה: -0.238530 ❌ (שלילית!)

שלב 2 - קורלציית מחזור:
├─ 15 נפחי MSFT אחרונים: [16.5M, 19.4M, 16.5M, ...]
├─ 15 נפחי ייחוס אחרונים: [...]
└─ קורלציה: 1.000000 ✅ (מושלמת!)

שלב 3 - שילוב (מצב 3):
├─ קורלציית שער: -0.238530 (שלילית)
├─ קורלציית מחזור: 1.000000 (חיובית)
├─ בדיקה: אחת מהן שלילית?
│   └─ כן! → תוצאה = 0
└─ תוצאה סופית: 0.000000

❌ אין סיגנל!
```

---

## 📊 דוגמה נוספת (מניה היפותטית)

נניח:

```
📊 נתוני גלם:
├─ מחיר: $150.00
└─ נפח: 5,000,000

🔬 חישוב קורלציות:

שלב 1 - קורלציית שער:
├─ 15 מחירים: [150, 149, 151, 148, 152, ...]
├─ 15 ייחוס: [205, 204, 206, 203, 207, ...]
└─ קורלציה: 0.85 ✅ (חזקה וחיובית!)

שלב 2 - קורלציית מחזור:
├─ 15 נפחים: [5M, 5.2M, 4.8M, 5.1M, ...]
├─ 15 ייחוס: [16.5M, 17M, 16M, 16.8M, ...]
└─ קורלציה: 0.72 ✅ (חיובית!)

שלב 3 - שילוב (מצב 3):
├─ קורלציית שער: 0.85 (חיובית)
├─ קורלציית מחזור: 0.72 (חיובית)
├─ בדיקה: שתיהן חיוביות?
│   └─ כן! → מכפלה
├─ חישוב: 0.85 × 0.72 = 0.612
└─ תוצאה סופית: 0.612

✅ יש סיגנל!
```

---

## 🎨 ייצוג ויזואלי

```
      קורלציית שער              קורלציית מחזור
           │                          │
           │                          │
    ┌──────▼────────┐          ┌──────▼────────┐
    │ 15 מחירים     │          │ 15 נפחים      │
    │ של המניה      │          │ של המניה      │
    │      VS       │          │      VS       │
    │ 15 מחירים     │          │ 15 נפחים      │
    │ של הייחוס     │          │ של הייחוס     │
    └──────┬────────┘          └──────┬────────┘
           │                          │
           │ CORREL                   │ CORREL
           │                          │
    ┌──────▼────────┐          ┌──────▼────────┐
    │  r = 0.85     │          │  r = 0.72     │
    └──────┬────────┘          └──────┬────────┘
           │                          │
           └────────┬──────────────────┘
                    │
           ┌────────▼────────┐
           │ שתיהן חיוביות? │
           └────────┬────────┘
                    │
         ┌──────────┴──────────┐
         │ כן                  │ לא
         ▼                     ▼
    ┌─────────┐           ┌─────────┐
    │ מכפלה   │           │  0      │
    │ 0.612   │           └─────────┘
    └─────────┘
```

---

## 🧮 למה מכפלה ולא חיבור?

### מכפלה (מצב 3):
```
0.85 × 0.72 = 0.612
```
✅ מחזק רק אם **שתיהן חזקות**
✅ מסנן אותות חלשים אוטומטית

### חיבור (לא בשימוש):
```
(0.85 + 0.72) / 2 = 0.785
```
❌ יכול לתת ממוצע גבוה גם אם אחת חלשה

### דוגמה:
```
קורלציות: 0.9 (מחיר) + 0.1 (נפח)

מכפלה: 0.9 × 0.1 = 0.09 ❌ (חלש!)
חיבור: (0.9 + 0.1) / 2 = 0.5 ✅? (נראה טוב אבל מטעה!)

→ המכפלה מגלה שהנפח חלש
```

---

## 🎯 כיצד זה מיושם ב-Python?

```python
def calculate_rolling_correlation(series, reference, window=15):
    """חישוב קורלציה גלילית"""
    correlations = []
    
    for i in range(len(series)):
        if i < window - 1:
            correlations.append(0)  # אין מספיק נתונים
        else:
            # 15 ערכים אחרונים (כולל הנוכחי)
            stock_window = series[i-window+1 : i+1]
            ref_window = reference[i-window+1 : i+1]
            
            # חישוב קורלציה פירסון
            corr = stock_window.corr(ref_window)
            correlations.append(corr if not np.isnan(corr) else 0)
    
    return correlations


def combine_correlations(price_corr, volume_corr, mode=3):
    """שילוב קורלציות"""
    if mode == 1:
        return price_corr
    elif mode == 2:
        return volume_corr
    elif mode == 3:
        # מכפלה רק אם שתיהן חיוביות
        if price_corr < 0 or volume_corr < 0:
            return 0
        return price_corr * volume_corr
    return 0
```

---

## ✅ סיכום

### חישוב הקורלציה באקסל:

1. **קורלציה גלילית (Rolling Correlation)**
   - לוקח 15 ערכים אחרונים
   - משווה למניית ייחוס
   - מחשב מקדם פירסון

2. **שתי קורלציות:**
   - מחיר (שער)
   - נפח (מחזור)

3. **שילוב במצב 3:**
   - אם שתיהן חיוביות → מכפלה
   - אם אחת שלילית → 0

4. **התוצאה:**
   - ערך בין 0 ל-1
   - ככל שגבוה יותר = קורלציה חזקה יותר
   - 0 = אין קורלציה או אחת שלילית

---

